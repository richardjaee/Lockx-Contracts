# Deposits contract

`Deposits.sol` is a lean helper that accepts incoming assets so the main `Lockx` contract never needs token-specific code. It keeps the external surface small, emits clean events, and forwards everything to the system treasury (a minimal proxy owned by `Lockx`).

## Why separate deposits?

* Avoids sprinkling ERC-20/ERC-721 logic throughout the core.
* Lets auditors focus on a short, self-contained file.
* Gas-efficient: one storage write per deposit, no loops.

## Supported asset types

| Asset | Entry point | Notes |
|-------|-------------|-------|
| Native ETH | `receive()` or `depositETH()` | Emits `EthDeposited` | 
| ERC-20 | `depositToken(address token, uint256 amount)` | Requires `allowance` first | 
| ERC-721 | `onERC721Received()` (safe transfer) | Single tokenId | 
| ERC-1155 | `onERC1155Received()` | Batch sends are rejected to keep logic simple |

## Core events

```solidity
EthDeposited(address indexed from, uint256 value);
ERC20Deposited(address indexed from, address indexed token, uint256 value);
ERC721Deposited(address indexed from, address indexed token, uint256 id);
ERC1155Deposited(address indexed from, address indexed token, uint256 id, uint256 value);
```

Every event also includes the `key` generated by `Lockx` so indexers can link deposits to locks.

## Life-cycle

1. User calls `Lockx.lock()`.
2. `Lockx` validates parameters then forwards the asset transfer to `Deposits`.
3. `Deposits` pulls or receives the asset, emits the event, then returns `true`.
4. `Lockx` finalises the lock state.

The contract is **stateless** beyond events: if it is ever compromised the attacker cannot move funds, because ownership checks live in `Lockx`.

---

## Function walkthrough

### depositETH
```solidity
function depositETH(uint256 tokenId, bytes32 referenceId) external payable
```
* **Purpose** – lets the Lockbox owner top-up ETH at any time.
* **Checks**  
  • `_requireOwnsLockbox(tokenId)` (msg.sender must own)  
  • `msg.value > 0` else `ZeroAmount`
* **Effects** – adds ETH to `_ethBalances[tokenId]` and emits `Deposited(tokenId, referenceId)`.

### depositERC20
```solidity
function depositERC20(uint256 tokenId,
                      address tokenAddress,
                      uint256 amount,
                      bytes32 referenceId) external
```
* Validates ownership, non-zero token address, non-zero amount.
* Delegates to `_depositERC20` which:
  1. Pulls tokens via `safeTransferFrom`.  
  2. Calculates real `received` delta to be fee-on-transfer safe.  
  3. Registers new token in `_erc20TokenAddresses` with O(1) index mapping.  
  4. Updates balance map.
* Emits `Deposited`.

### depositERC721
```solidity
function depositERC721(uint256 tokenId,
                       address nftContract,
                       uint256 nftTokenId,
                       bytes32 referenceId) external
```
* Checks ownership and non-zero `nftContract`.
* Calls `_depositERC721` → safeTransfer NFT and write `(contract, id)` to packed mapping using keccak key.

### batchDeposit
Allows a single tx to deposit ETH **+** multiple ERC-20s **+** multiple ERC-721s.
* Guards: non-empty payload, msg.value matches `amountETH`, array length matches.
* Loops over arrays with unchecked increments for gas.

---

### Internal helpers
* `_depositETH` – single line `+=`.
* `_depositERC20` – handles pull, delta, token registration.
* `_depositERC721` – handles NFT key registration and safeTransfer.
* `_batchDeposit` – orchestrates calls above with minimal branching.
* Removal utilities (`_removeERC20Token`, `_removeNFTKey`) keep arrays dense when tokens are fully withdrawn (called by Withdrawals).

---

## Storage snapshot

| Mapping | Purpose |
|---------|---------|
| `_ethBalances[tokenId]` | Total ETH held |
| `_erc20Balances[tokenId][token]` | ERC-20 amount |
| `_erc20TokenAddresses[tokenId]` | Compact list for iteration |
| `_nftKeys[tokenId]` | Array of keccak(contract, id) keys |
| `_lockboxNftData[tokenId][key]` | `address contract`, `uint256 id` |

---

Continue to [Withdrawals helper](withdrawals.md) for release logic.
